name: Daily Nasdaq News Summary

on:
  schedule:
    - cron: '30 23 * * *'  # ë§¤ì¼ ì˜¤ì „ 8:30 KST
  workflow_dispatch:

jobs:
  run-summary:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run summarizer
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python main.py

      - name: Upload output files (Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: nasdaq-results
          path: |
            nasdaq_metadata.csv
            nasdaq_index.faiss

      # âœ… Google Cloud ì¸ì¦
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS }}

      # âœ… Google Driveì— íŒŒì¼ ì—…ë¡œë“œ (ìˆ˜ì •ëœ ë¶€ë¶„)
      - name: Upload files to Google Drive
        env:
          FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          # Access Token ê°€ì ¸ì˜¤ê¸°
          TOKEN=$(gcloud auth print-access-token)
          
          # Access Tokenì´ ì—†ì„ ê²½ìš° ì‹¤íŒ¨ ì²˜ë¦¬
          if [[ -z "$TOKEN" ]]; then
            echo "âŒ ERROR: Failed to obtain Access Token"
            exit 1
          fi

          echo "âœ… Google Drive Upload ì‹œì‘"

          # Google Drive API URL
          DRIVE_API="https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&supportsAllDrives=true"

          # ğŸŸ¢ nasdaq_metadata.csv ì—…ë¡œë“œ
          echo "ğŸ“‚ Uploading nasdaq_metadata.csv..."
          curl -X POST -L \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: multipart/related; boundary=foo_bar_baz" \
            --data-binary @- "$DRIVE_API" <<EOF
          --foo_bar_baz
          Content-Type: application/json; charset=UTF-8

          {
            "name": "nasdaq_metadata.csv",
            "parents": ["$FOLDER_ID"]
          }

          --foo_bar_baz
          Content-Type: application/octet-stream

          $(cat nasdaq_metadata.csv)
          --foo_bar_baz--
          EOF

          # ğŸŸ¢ nasdaq_index.faiss ì—…ë¡œë“œ
          echo "ğŸ“‚ Uploading nasdaq_index.faiss..."
          curl -X POST -L \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: multipart/related; boundary=foo_bar_baz" \
            --data-binary @- "$DRIVE_API" <<EOF
          --foo_bar_baz
          Content-Type: application/json; charset=UTF-8

          {
            "name": "nasdaq_index.faiss",
            "parents": ["$FOLDER_ID"]
          }

          --foo_bar_baz
          Content-Type: application/octet-stream

          $(cat nasdaq_index.faiss)
          --foo_bar_baz--
          EOF

          echo "âœ… Google Drive Upload ì™„ë£Œ"
